<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cozy Home Garden</title>
  <style>
    :root {
      --bg: #0e1423;
      --panel: rgba(15, 20, 35, 0.6);
      --border: rgba(255,255,255,0.14);
      --text: #eef6ff;
      --accent: #74c0fc;
      --moist: #4dabf7;
      --sun: #ffd43b;
      --soil: #94d82d;
      --good: #51cf66;
      --warn: #ffa94d;
      --bad: #ff6b6b;
    }
    html, body {
      margin: 0;
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, Helvetica, "Apple Color Emoji", "Segoe UI Emoji";
      overflow: hidden;
      user-select: none;
    }
    #canvas { display: block; width: 100vw; height: 100vh; }
    #ui {
      position: absolute; left: 0; right: 0; top: 8px;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 10px; gap: 10px; pointer-events: none;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
      padding: 8px 12px; pointer-events: auto;
    }
    .hud { display: flex; gap: 10px; align-items: center; }
    .bars { display: flex; gap: 12px; align-items: center; }
    .bar { width: 180px; height: 14px; background: rgba(255,255,255,0.08); border-radius: 7px; position: relative; overflow: hidden; }
    .bar .fill { position: absolute; left: 0; top: 0; bottom: 0; width: 0%; border-radius: 7px; }
    .bar .label { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 11px; color: rgba(255,255,255,0.9); text-shadow: 0 1px 2px rgba(0,0,0,0.6); }
    .title { font-size: 18px; font-weight: 800; letter-spacing: .3px; }
    .hint { opacity: 0.85; font-size: 13px; }

    #actions {
      position: absolute; right: 10px; bottom: 10px; display: flex; gap: 10px;
    }
    button.action {
      background: linear-gradient(180deg, #4460f2, #2c44d1);
      border: 0; color: white; font-weight: 800; letter-spacing: .3px;
      padding: 10px 12px; border-radius: 10px; cursor: pointer;
      min-width: 110px; box-shadow: 0 6px 18px rgba(44,68,209,0.35);
      display: flex; align-items: center; gap: 8px;
    }
    button.action:disabled { opacity: .6; filter: grayscale(.2); cursor: not-allowed; }
    .ico { width: 18px; height: 18px; display: inline-block; }

    #overlay {
      position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none;
    }
    .overlay-card {
      pointer-events: auto;
      text-align: center; max-width: 520px;
    }
    .big { font-size: 38px; font-weight: 900; margin-bottom: 6px; text-shadow: 0 3px 12px rgba(0,0,0,0.55); }
    .sub { opacity: .9; }
    .overlay-actions { margin-top: 12px; }
    .primary {
      background: linear-gradient(180deg, #4b6bff, #2640d9);
      color: white; border: none; border-radius: 10px; padding: 10px 16px; font-weight: 800; cursor: pointer;
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>
  <div id="ui">
    <div class="panel hud">
      <div class="title">Cozy Home Garden</div>
      <div id="stage" class="hint">Stage: Seed</div>
      <div class="bars">
        <div class="bar" title="Moisture">
          <div class="fill" id="moistFill" style="background: linear-gradient(90deg, #74c0fc, #4dabf7);"></div>
          <div class="label">Water</div>
        </div>
        <div class="bar" title="Sunlight">
          <div class="fill" id="sunFill" style="background: linear-gradient(90deg, #ffd43b, #fcc419);"></div>
          <div class="label">Sun</div>
        </div>
        <div class="bar" title="Soil Health">
          <div class="fill" id="soilFill" style="background: linear-gradient(90deg, #a0e34a, #74c251);"></div>
          <div class="label">Soil</div>
        </div>
        <div class="hint" id="growthTxt">Growth: 0%</div>
      </div>
    </div>
    <div class="panel hint">Controls: Water [W] • Sunlight [L] • Soil Care [C] • Restart [R]</div>
  </div>
  <div id="actions">
    <button id="btnWater" class="action" title="Add Water (W)">
      <span class="ico" style="background: radial-gradient(circle at 30% 30%, #a5d8ff, #1e90ff);
      border-radius: 50%; box-shadow: inset 0 0 6px rgba(0,0,0,0.25);"></span>
      Water
    </button>
    <button id="btnSun" class="action" title="Add Sunlight (L)" style="background: linear-gradient(180deg, #ffdd66, #f2b600); box-shadow: 0 6px 18px rgba(240,180,0,0.35);">
      <span class="ico" style="background: radial-gradient(circle at 40% 40%, #fff389, #ffcc00);
      border-radius: 50%; box-shadow: inset 0 0 6px rgba(0,0,0,0.25);"></span>
      Sunlight
    </button>
    <button id="btnSoil" class="action" title="Improve Soil (C)" style="background: linear-gradient(180deg, #6cc157, #3ea43a); box-shadow: 0 6px 18px rgba(30,140,20,0.35);">
      <span class="ico" style="background: conic-gradient(from 0deg, #8bc34a, #6aa84f, #5b8c3a, #8bc34a);
      border-radius: 50%; box-shadow: inset 0 0 6px rgba(0,0,0,0.25);"></span>
      Soil Care
    </button>
  </div>
  <div id="overlay"></div>

  <script>
  (() => {
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const overlay = document.getElementById('overlay');

    // HUD elements
    const stageEl = document.getElementById('stage');
    const moistFill = document.getElementById('moistFill');
    const sunFill = document.getElementById('sunFill');
    const soilFill = document.getElementById('soilFill');
    const growthTxt = document.getElementById('growthTxt');

    const btnWater = document.getElementById('btnWater');
    const btnSun = document.getElementById('btnSun');
    const btnSoil = document.getElementById('btnSoil');

    // Device pixel ratio & resize
    function resize() {
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      canvas.width = Math.floor(window.innerWidth * dpr);
      canvas.height = Math.floor(window.innerHeight * dpr);
      canvas.style.width = window.innerWidth + 'px';
      canvas.style.height = window.innerHeight + 'px';
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    window.addEventListener('resize', resize);

    // Game State
    const state = {
      moisture: 55,
      sunlight: 55,
      soil: 60,
      growth: 0, // 0..100
      dayTime: 0, // 0..1
      stage: 0, // 0: seed, 1: grass, 2: plants, 3: banyan
      gameOver: false,
    };

    const stages = [
      { name: 'Seed', threshold: 0 },
      { name: 'Grass', threshold: 25 },
      { name: 'Small Plants', threshold: 50 },
      { name: 'Majestic Banyan', threshold: 80 },
    ];

    // Rates (per second)
    const decay = { moisture: 0.35, sunlight: 0.25, soil: 0.1 };
    const gain = { water: 24, sun: 20, soil: 16 };

    // Cooldowns (ms)
    const cooldowns = { water: 2500, sun: 2500, soil: 5000 };
    const lastUse = { water: -Infinity, sun: -Infinity, soil: -Infinity };

    // Visual effects particles
    const droplets = []; // {x,y,vx,vy,life}
    const sunrays = []; // {x,y,rot,life}
    const leafs = [];   // {x,y,vx,vy,rot,life}

    function addWaterFX() {
      const cx = canvas.clientWidth * 0.5;
      const cy = canvas.clientHeight * 0.65;
      for (let i = 0; i < 16; i++) {
        const ang = Math.random() * Math.PI - Math.PI/2;
        const spd = 60 + Math.random() * 80;
        droplets.push({ x: cx + (Math.random()-0.5)*40, y: cy - 40 + (Math.random()-0.5)*10, vx: Math.cos(ang)*spd, vy: Math.sin(ang)*spd, life: 0.9 + Math.random()*0.6 });
      }
    }
    function addSunFX() {
      const cx = canvas.clientWidth * 0.5;
      const cy = canvas.clientHeight * 0.3;
      for (let i = 0; i < 10; i++) {
        sunrays.push({ x: cx + (Math.random()-0.5)*120, y: cy + (Math.random()-0.5)*60, rot: Math.random()*Math.PI, life: 0.7 + Math.random()*0.7 });
      }
    }
    function addLeafFX() {
      const cx = canvas.clientWidth * 0.5;
      const cy = canvas.clientHeight * 0.68;
      for (let i = 0; i < 10; i++) {
        const spd = 20 + Math.random() * 40;
        const ang = -Math.PI/2 + (Math.random()-0.5)*0.8;
        leafs.push({ x: cx + (Math.random()-0.5)*40, y: cy + (Math.random()-0.5)*20, vx: Math.cos(ang)*spd, vy: Math.sin(ang)*spd, rot: Math.random()*Math.PI*2, life: 1 + Math.random()*0.8 });
      }
    }

    function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }

    function applyAction(name) {
      const now = performance.now();
      if (now - lastUse[name] < cooldowns[name]) return;
      lastUse[name] = now;
      if (name === 'water') { state.moisture = clamp(state.moisture + gain.water, 0, 100); addWaterFX(); }
      if (name === 'sun')   { state.sunlight = clamp(state.sunlight + gain.sun, 0, 100); addSunFX(); }
      if (name === 'soil')  { state.soil = clamp(state.soil + gain.soil, 0, 100); addLeafFX(); }
    }

    // Input
    btnWater.addEventListener('click', () => applyAction('water'));
    btnSun.addEventListener('click', () => applyAction('sun'));
    btnSoil.addEventListener('click', () => applyAction('soil'));

    window.addEventListener('keydown', e => {
      if (state.gameOver && e.code === 'KeyR') { start(); return; }
      if (e.code === 'KeyW') applyAction('water');
      else if (e.code === 'KeyL') applyAction('sun');
      else if (e.code === 'KeyC') applyAction('soil');
      else if (e.code === 'KeyR') start();
    });

    function updateButtons() {
      const now = performance.now();
      btnWater.disabled = now - lastUse.water < cooldowns.water;
      btnSun.disabled = now - lastUse.sun < cooldowns.sun;
      btnSoil.disabled = now - lastUse.soil < cooldowns.soil;
    }

    // Plant growth rules
    function computeGrowthRate() {
      // Good ranges
      const goodWater = state.moisture >= 40 && state.moisture <= 80;
      const goodSun   = state.sunlight >= 35 && state.sunlight <= 85;
      const goodSoil  = state.soil >= 55;
      const count = (goodWater?1:0) + (goodSun?1:0) + (goodSoil?1:0);

      if (count === 3) return 8;      // flourishing
      if (count === 2) return 4;      // growing nicely
      if (count === 1) return 1.5;    // slow growth
      // bad conditions
      if (state.moisture < 18 || state.sunlight < 18 || state.soil < 30) return -1; // wilting
      return 0; // stagnant
    }

    function stageFromGrowth(g) {
      if (g >= stages[3].threshold) return 3;
      if (g >= stages[2].threshold) return 2;
      if (g >= stages[1].threshold) return 1;
      return 0;
    }

    function update(dt) {
      // day-night cycle
      state.dayTime = (state.dayTime + dt*0.02) % 1; // one cycle ~50s

      // natural decay
      state.moisture = clamp(state.moisture - decay.moisture * dt, 0, 100);
      state.sunlight = clamp(state.sunlight - decay.sunlight * dt, 0, 100);
      state.soil = clamp(state.soil - decay.soil * dt, 0, 100);

      // growth
      const rate = computeGrowthRate();
      state.growth = clamp(state.growth + rate * dt, 0, 100);

      // stage changes
      const newStage = stageFromGrowth(state.growth);
      if (newStage !== state.stage) {
        state.stage = newStage;
      }

      // win condition
      if (!state.gameOver && state.stage === 3 && state.growth >= 100) {
        state.gameOver = true;
        showWin();
      }

      // particles update
      for (let i = droplets.length - 1; i >= 0; i--) {
        const p = droplets[i];
        p.life -= dt*0.8;
        p.x += p.vx * dt; p.y += p.vy * dt; p.vy += 220 * dt;
        if (p.life <= 0) droplets.splice(i, 1);
      }
      for (let i = sunrays.length - 1; i >= 0; i--) {
        const r = sunrays[i];
        r.life -= dt*0.6; r.rot += dt * 0.8;
        if (r.life <= 0) sunrays.splice(i, 1);
      }
      for (let i = leafs.length - 1; i >= 0; i--) {
        const f = leafs[i];
        f.life -= dt*0.7; f.x += f.vx * dt; f.y += f.vy * dt; f.vy += 40*dt; f.rot += dt*2;
        if (f.life <= 0) leafs.splice(i, 1);
      }
      updateHud();
      updateButtons();
    }

    function updateHud() {
      stageEl.textContent = 'Stage: ' + stages[state.stage].name;
      moistFill.style.width = state.moisture.toFixed(0) + '%';
      sunFill.style.width = state.sunlight.toFixed(0) + '%';
      soilFill.style.width = state.soil.toFixed(0) + '%';
      growthTxt.textContent = 'Growth: ' + Math.floor(state.growth) + '%';
    }

    // Drawing helpers
    function drawBackground() {
      const w = canvas.clientWidth; const h = canvas.clientHeight;
      // sky colors based on dayTime
      const t = state.dayTime;
      const day = [ {r: 15, g: 140, b: 240}, {r: 135, g: 206, b: 250} ];
      const dusk = [ {r: 18, g: 24, b: 40}, {r: 50, g: 60, b: 100} ];
      // blend
      const phase = Math.sin(t * Math.PI * 2) * 0.5 + 0.5; // 0..1
      const mix = (a,b,m)=>(a*(1-m)+b*m)|0;
      const top = `rgb(${mix(dusk[0].r, day[0].r, phase)}, ${mix(dusk[0].g, day[0].g, phase)}, ${mix(dusk[0].b, day[0].b, phase)})`;
      const bottom = `rgb(${mix(dusk[1].r, day[1].r, phase)}, ${mix(dusk[1].g, day[1].g, phase)}, ${mix(dusk[1].b, day[1].b, phase)})`;
      const g = ctx.createLinearGradient(0,0,0,h*0.7);
      g.addColorStop(0, top); g.addColorStop(1, bottom);
      ctx.fillStyle = g; ctx.fillRect(0,0,w,h);

      // sun
      const sunX = w*0.5 + Math.cos(t * Math.PI * 2 - Math.PI/2) * w*0.35;
      const sunY = h*0.25 + Math.sin(t * Math.PI * 2 - Math.PI/2) * h*0.18;
      const sg = ctx.createRadialGradient(sunX, sunY, 10, sunX, sunY, 120);
      sg.addColorStop(0, 'rgba(255, 230, 120, 1)');
      sg.addColorStop(1, 'rgba(255, 230, 120, 0)');
      ctx.fillStyle = sg; ctx.beginPath(); ctx.arc(sunX, sunY, 120, 0, Math.PI*2); ctx.fill();

      // distant clouds
      ctx.globalAlpha = 0.5 * (0.7 + 0.3*phase);
      drawCloud(sunX-200, sunY-40, 70);
      drawCloud(sunX+150, sunY+10, 60);
      ctx.globalAlpha = 1;

      // fence
      drawFence();

      // ground
      drawGround();
    }

    function drawCloud(cx, cy, r) {
      ctx.fillStyle = 'rgba(255,255,255,0.75)';
      ctx.beginPath();
      for (let i=0;i<5;i++) ctx.arc(cx + (i-2)*r*0.6, cy + (i%2? -r*0.2 : 0), r*0.6 + (i%2? r*0.2:0), 0, Math.PI*2);
      ctx.fill();
    }

    function drawFence() {
      const w = canvas.clientWidth; const h = canvas.clientHeight;
      const y = h*0.72;
      // posts
      for (let x = 0; x < w+40; x += 32) {
        ctx.fillStyle = '#c9b18a';
        ctx.fillRect(x, y-40, 18, 80);
        ctx.strokeStyle = 'rgba(0,0,0,0.25)';
        ctx.lineWidth = 2; ctx.strokeRect(x, y-40, 18, 80);
      }
      // rails
      ctx.fillStyle = '#d1bb93';
      ctx.fillRect(0, y-10, w, 14);
      ctx.fillRect(0, y+18, w, 14);
      ctx.strokeStyle = 'rgba(0,0,0,0.25)'; ctx.strokeRect(0, y-10, w, 14); ctx.strokeRect(0, y+18, w, 14);
    }

    function drawGround() {
      const w = canvas.clientWidth; const h = canvas.clientHeight;
      const y = h*0.8; const g = ctx.createLinearGradient(0, y-100, 0, h);
      g.addColorStop(0, '#7bbb66'); g.addColorStop(1, '#2f7b35');
      ctx.fillStyle = g; ctx.fillRect(0, y, w, h-y);

      // subtle grass blades
      ctx.strokeStyle = 'rgba(255,255,255,0.06)';
      ctx.lineWidth = 1;
      for (let x=0; x<w; x+=8) {
        const gy = y + 4 + Math.sin((x*0.02+state.dayTime*6)) * 2;
        ctx.beginPath(); ctx.moveTo(x, y); ctx.quadraticCurveTo(x-2, gy-6, x, gy); ctx.stroke();
      }

      // soil patch at center
      const cx = w*0.5, cy = h*0.8;
      ctx.fillStyle = '#5b3e2b';
      ctx.beginPath(); ctx.ellipse(cx, cy, 120, 36, 0, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = '#6d4a31'; ctx.beginPath(); ctx.ellipse(cx, cy+4, 110, 28, 0, 0, Math.PI*2); ctx.fill();
    }

    function drawPlant() {
      const w = canvas.clientWidth; const h = canvas.clientHeight;
      const cx = w*0.5, cy = h*0.8;

      // root/soil details
      ctx.fillStyle = 'rgba(0,0,0,0.06)';
      for (let i=0;i<6;i++) {
        const rx = cx + (Math.random()-0.5)*80; const ry = cy + 10 + Math.random()*10;
        ctx.fillRect(rx, ry, 2, 4);
      }

      const g = state.growth; // 0..100
      const t = (g - stages[state.stage].threshold) / Math.max(1, (state.stage<3? stages[state.stage+1].threshold : 100) - stages[state.stage].threshold);

      // stage-based drawing
      if (state.stage === 0) drawSeed(cx, cy, t);
      else if (state.stage === 1) { drawGrass(cx, cy, t); drawSeedling(cx, cy, t*0.6); }
      else if (state.stage === 2) { drawGrass(cx, cy, 1); drawPlants(cx, cy, t); }
      else { drawGrass(cx, cy, 1); drawBanyan(cx, cy, t); }

      // progress ring
      drawProgress(cx, cy-70, g/100);

      // particles
      drawParticles();
    }

    function drawSeed(cx, cy, t) {
      ctx.save();
      ctx.translate(cx, cy);
      ctx.fillStyle = '#704b2e'; ctx.strokeStyle = 'rgba(0,0,0,0.35)'; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.ellipse(0, 0, 10+6*t, 7+5*t, Math.PI/8, 0, Math.PI*2); ctx.fill(); ctx.stroke();
      ctx.restore();
    }

    function drawGrass(cx, cy, t) {
      // t: 0..1 density
      const blades = Math.floor(60 * t);
      ctx.strokeStyle = '#2f7b35'; ctx.lineWidth = 2;
      for (let i=0;i<blades;i++) {
        const x = cx - 80 + Math.random()*160;
        const y = cy + 8 + Math.random()*10;
        const h = 8 + Math.random()*18;
        ctx.beginPath(); ctx.moveTo(x, cy); ctx.quadraticCurveTo(x-3, y-h/2, x, y-h); ctx.stroke();
      }
    }

    function drawSeedling(cx, cy, t) {
      ctx.save(); ctx.translate(cx, cy);
      const stemH = 20 + 20*t; const sway = Math.sin(performance.now()*0.002)*2;
      ctx.strokeStyle = '#3a9c4b'; ctx.lineWidth = 3; ctx.lineCap = 'round';
      ctx.beginPath(); ctx.moveTo(0, 0); ctx.quadraticCurveTo(sway, -stemH/2, sway*2, -stemH); ctx.stroke();
      // leaves
      ctx.fillStyle = '#4fcf70';
      ctx.beginPath(); ctx.ellipse(-6, -stemH+6, 10, 6, -0.6, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(10, -stemH+2, 12, 7, 0.6, 0, Math.PI*2); ctx.fill();
      ctx.restore();
    }

    function drawPlants(cx, cy, t) {
      // multiple stems with leaves
      const stems = 3 + Math.floor(3*t);
      for (let i=0;i<stems;i++) {
        const off = -40 + i*(80/(stems-1));
        const baseH = 40 + i*4; const grow = 40*t;
        const H = baseH + grow;
        ctx.strokeStyle = '#378c46'; ctx.lineWidth = 4; ctx.lineCap = 'round';
        ctx.beginPath(); ctx.moveTo(cx+off, cy-4); ctx.quadraticCurveTo(cx+off+6, cy-H/2, cx+off, cy-H); ctx.stroke();
        // leaves per stem
        for (let k=0;k<4;k++) {
          const lh = cy - H*(0.2+0.18*k);
          ctx.fillStyle = '#4fcf70';
          ctx.beginPath(); ctx.ellipse(cx+off-10, lh, 14, 8, -0.7, 0, Math.PI*2); ctx.fill();
          ctx.beginPath(); ctx.ellipse(cx+off+12, lh-4, 16, 9, 0.7, 0, Math.PI*2); ctx.fill();
        }
      }
    }

    function drawBanyan(cx, cy, t) {
      // trunk
      const trunkH = 180 * (0.6 + 0.4*t), trunkW = 36 * (0.7 + 0.3*t);
      ctx.fillStyle = '#7d5a3b'; ctx.strokeStyle = 'rgba(0,0,0,0.35)'; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(cx-trunkW/2, cy);
      ctx.quadraticCurveTo(cx-trunkW*0.6, cy-trunkH*0.4, cx-trunkW*0.3, cy-trunkH);
      ctx.lineTo(cx+trunkW*0.3, cy-trunkH);
      ctx.quadraticCurveTo(cx+trunkW*0.6, cy-trunkH*0.4, cx+trunkW/2, cy);
      ctx.closePath(); ctx.fill(); ctx.stroke();

      // canopy
      const canopyR = 140 * (0.6 + 0.4*t);
      const cg = ctx.createRadialGradient(cx, cy-trunkH-10, canopyR*0.3, cx, cy-trunkH-10, canopyR);
      cg.addColorStop(0, '#3da35b'); cg.addColorStop(1, '#1e6f3d');
      ctx.fillStyle = cg; ctx.beginPath(); ctx.ellipse(cx, cy-trunkH-10, canopyR*1.2, canopyR*0.9, 0, 0, Math.PI*2); ctx.fill();

      // aerial roots (banyan feature)
      ctx.strokeStyle = '#8b6a4a'; ctx.lineWidth = 3;
      for (let i= -3; i<=3; i++) {
        if (Math.abs(i) === 3 && t < 0.6) continue;
        const rx = cx + i * canopyR * 0.22;
        const len = 40 + Math.random()*20 + t*40;
        ctx.beginPath(); ctx.moveTo(rx, cy-trunkH*0.5);
        ctx.quadraticCurveTo(rx+ (Math.random()-0.5)*10, cy-trunkH*0.2, rx + (Math.random()-0.5)*8, cy-trunkH*0.5 + len);
        ctx.stroke();
      }

      // highlights
      ctx.globalAlpha = 0.08; ctx.fillStyle = '#ffffff';
      ctx.beginPath(); ctx.ellipse(cx-canopyR*0.2, cy-trunkH-20, canopyR*0.8, canopyR*0.5, -0.2, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1;
    }

    function drawProgress(x, y, p) {
      const r = 28; const thick = 6;
      // back
      ctx.strokeStyle = 'rgba(255,255,255,0.15)'; ctx.lineWidth = thick; ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.stroke();
      // front
      const col = p >= 0.99 ? '#51cf66' : (p >= 0.5 ? '#ffd43b' : '#74c0fc');
      ctx.strokeStyle = col; ctx.lineCap = 'round'; ctx.beginPath(); ctx.arc(x, y, r, -Math.PI/2, -Math.PI/2 + p * Math.PI*2); ctx.stroke();
      ctx.fillStyle = 'rgba(0,0,0,0.4)'; ctx.font = 'bold 12px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(Math.floor(p*100)+'%', x, y);
    }

    function drawParticles() {
      // water droplets
      for (const p of droplets) {
        const a = Math.max(0, Math.min(1, p.life));
        ctx.fillStyle = `rgba(100, 180, 255, ${a})`;
        ctx.beginPath(); ctx.ellipse(p.x, p.y, 2.5, 4.5, 0, 0, Math.PI*2); ctx.fill();
      }
      // sun rays
      for (const r of sunrays) {
        const a = Math.max(0, Math.min(1, r.life));
        ctx.save(); ctx.translate(r.x, r.y); ctx.rotate(r.rot);
        const grad = ctx.createLinearGradient(0,-30,0,30);
        grad.addColorStop(0, `rgba(255,240,150,0)`);
        grad.addColorStop(0.5, `rgba(255,240,150,${0.4*a})`);
        grad.addColorStop(1, `rgba(255,240,150,0)`);
        ctx.fillStyle = grad; ctx.fillRect(-3,-30,6,60); ctx.restore();
      }
      // leaves
      for (const f of leafs) {
        const a = Math.max(0, Math.min(1, f.life));
        ctx.save(); ctx.translate(f.x, f.y); ctx.rotate(f.rot);
        ctx.fillStyle = `rgba(80, 200, 100, ${a})`;
        ctx.beginPath(); ctx.ellipse(0, 0, 8, 5, 0.3, 0, Math.PI*2); ctx.fill(); ctx.restore();
      }
    }

    function showWin() {
      overlay.innerHTML = '';
      const card = document.createElement('div');
      card.className = 'panel overlay-card';
      const title = document.createElement('div'); title.className = 'big'; title.textContent = 'A Majestic Banyan!';
      const sub = document.createElement('div'); sub.className = 'sub'; sub.textContent = 'Your care transformed a tiny seed into a grand tree—the heart of your cozy garden.';
      const actions = document.createElement('div'); actions.className = 'overlay-actions';
      const again = document.createElement('button'); again.className = 'primary'; again.textContent = 'Plant Again (R)';
      again.addEventListener('click', start);
      actions.appendChild(again);
      card.appendChild(title); card.appendChild(sub); card.appendChild(actions);
      overlay.appendChild(card);
    }

    function start() {
      state.moisture = 55; state.sunlight = 55; state.soil = 60; state.growth = 0; state.stage = 0; state.gameOver = false;
      lastUse.water = lastUse.sun = lastUse.soil = -Infinity;
      overlay.innerHTML = '';
    }

    // Main loop
    let lastTime = 0;
    function loop(t) {
      if (!lastTime) lastTime = t; const dt = Math.min(0.05, (t - lastTime) / 1000); lastTime = t;
      update(dt);
      drawBackground();
      drawPlant();
      requestAnimationFrame(loop);
    }

    // Bootstrap
    resize();
    start();
    requestAnimationFrame(loop);
  })();
  </script>
</body>
</html>
